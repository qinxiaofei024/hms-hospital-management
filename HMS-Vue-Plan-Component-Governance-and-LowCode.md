# 四平市中心人民医院 2025年医院绩效管理方案（可执行版）

本文档在既有方案基础上，统一原则与核算口径，明确公式与参数范围，完善治理与审计机制，使绩效管理“可落地、可审计、风险可控”。

## 一、总体目标与政策依据
- 目标：建立以价值为导向、质量为核心、成本受控、优绩优酬的绩效管理体系，强化医务人员劳动与技术价值体现。
- 政策依据：坚持落实现代医院管理制度要求，遵循公立医院绩效考核与薪酬制度改革精神，结合本院战略与学科发展规划执行。

## 二、适用范围与职系分类
- 适用范围：全院在编/聘用职工与实际承担医疗服务的相关人员。
- 职系分类：医疗、护理、医技、医辅、行政五大职系，分类考核与分配。

## 三、术语与口径定义
- RBRVS（相对价值量表）：对诊疗项目的技术难度、强度与风险赋值形成“项目点数”，用于反映劳动与技术价值。
- DRG：按疾病诊断相关分组进行病例分组与权重计价，用于体现病种结构与复杂度差异。
- CMI（病例组合指数）：反映收治病例整体复杂度的结构性指标，用于质量/结构评估与校准，不直接用于逐例计价。
- 点数：经本院点数字典确定的RBRVS项目工作量单位。
- 点单价：按分组科类测算的点数货币换算系数，采用预算与历史有效点数法（不含激励）。
- KPI系数：质量与运营等关键指标的系数化结果，用于乘数调整，统一取值区间。
- 成本：运营成本包含人力、可控、固定与间接等，按明确分摊基准计入科室核算。

## 四、统一总公式与参数范围
- 统一总公式（核算单元级）：
  - 绩效总额 = Max(0, 收入基数 − 运营成本) × KPI系数 + 单项奖励
  - 收入基数 = RBRVS收入 + DRG病种收入
- 参数范围：
  - KPI系数统一区间：0.85—1.10（默认值1.00），不同职系按权重计算后映射到该区间。
  - 负值处理：当“收入基数 − 运营成本 ≤ 0”时取0，下限保护不产生负绩效。
  - 点单价：采用“预算总额（不含单项奖励）/历史有效点数”测算，按科类分组并季度微调，设封顶与上下限（±10%/季）。

## 五、分职系核算公式与说明
### 5.1 医疗职系
- 基数定义：医疗基数 = 工作量绩效（RBRVS项目点数×点单价） + 病种绩效（∑DRG权重×基础费率） − 运营成本
- 医疗绩效：医疗绩效 = 医疗基数 × [A% + (1 − A%) × KPI系数] + 单项奖励
  - A%为固定比例（建议0.6—0.8）；A%由医院统一设定并公示。
- 工作量绩效构成（严格去重）：
  - 服务量点数（不含手术/介入）
  - 执行工作量点数（操作、治疗、会诊等）
  - 手术/介入工作量点数（在手术室/介入室产生）
  - 注：服务量点数不得包含手术/介入点数，避免重复计入。
- 病种绩效：逐例“DRG权重×基础费率”计价；CMI仅用于结构评估与科室复杂度校准，不直接与病例数相乘计价。

### 5.2 护理职系
- 护理基数 = [护理执行工作量点数 + 协作点数 + 服务量点数] × 点单价 − 运营成本
- 护理绩效 = 护理基数 × KPI系数 + 单项奖励
- 护理间接工作量：采用护理时数核算（如：[(入院+出院)×系数 + 总床日] × 护理时数 ×系数），转化为点数后计入工作量绩效。

### 5.3 医技职系
- 医技基数 = [∑医技执行工作量点数 + 体检协作工作量] × 点单价 − 运营成本
- 医技绩效 = 医技基数 × KPI系数 + 单项奖励（超额累进，需质量阈值达标）

### 5.4 医辅职系
- 医辅基数 = ∑专项工作量点数 × 点单价 − 运营成本
- 医辅绩效 = 医辅基数 × KPI系数
- 专项工作量指标与点数：按科室业务特点设定，纳入指标字典并公示。

### 5.5 行政职系
- 行政绩效 = 个人综合岗位系数 × 行政绩效点值 × 质控考核系数
  - 岗位系数：以权责、影响、沟通、复杂性、强度等要素分级（示例A/B/C/D→数值如1.3/1.15/1.0/0.9），统一发布岗位系数表。
  - 质控考核系数：区间0.90—1.05，按年度质控达标率映射。

## 六、KPI指标体系与映射
- KPI系数统一区间：0.85—1.10，按分职系权重映射：
  - 临床科室：质量安全（40%）、路径执行/必要性（25%）、药耗占比（15%）、患者满意度（20%）
  - 医技科室：报告时效（30%）、预约完成率（25%）、差错率/返工率（25%）、临床匹配度/阳性贡献（20%）
  - 病区护理：月度护理质量（40%）、不良事件率（20%）、护理文书质量（20%）、患者满意度（20%）
  - 医辅科室：服务及时性（40%）、合规率（30%）、支持满意度（30%）
- 评分到系数映射示例（百分制）：
  - 95—100分→1.05—1.10；85—94分→1.00—1.04；75—84分→0.95—0.99；<75分→0.85—0.94。
- 达标门槛：质量/安全类指标不达标（如核心制度项）则KPI系数不高于1.00；严重不达标触发扣减至0.90及审计。

## 七、运营成本管控与分摊
- 分类与边界：
  - 人力成本（工资、保险、外聘、护理员等）
  - 可控成本（不计价卫生材料、试剂、低值易耗等）
  - 固定成本（设备折旧、房屋折旧）
  - 间接成本（水电、保洁、物业维修、洗涤等）
- 分摊基准示例：
  - 占床日（病区类）、检查台时/人次（医技类）、手术分钟数（手术室/介入）、面积（公共区域间接成本）
- 医护分摊：不计价卫生材料、试剂等按“实际耗用结构”分摊，原则上“医护各50%”为默认值，但允许依据耗用记录按季度校准（±10%）。
- 计入比例：
  - 人力成本按应发合计的比例计入（示例40%—56%，具体以年度预算与政策确定并公示）。
  - 可控成本、低值易耗、试剂原则上计入比例100%。
  - 固定与间接成本按20%—60%分摊，分摊比例与基准需统一在“成本分摊字典”中公示。
- 负值与扶持：当基数扣减后为0时，触发扶持政策评估；退出机制：连续两期达标即退出扶持。

## 八、单项奖励规则（质量门槛与上限）
- 四级及微创手术奖励：四级手术500元/例；微创按清单奖励。质量门槛：并发症率、再入院率、术后感染率未达标的不享受奖励；设年度上限与病例结构校准。
- 日间手术奖励：24小时出院100元/例、48小时出院50元/例；需满足路径与无再干预门槛。
- 节假日手术奖励：以当月“工作日基数（动态调整）”的90%为基数，超出部分节假日工作量点数上浮50%；同时设质量门槛与合理上限。
- 门诊单项奖励（修订）：有效门诊以“治疗性/操作性项目”认定，检查检验类项目不纳入直接奖励；有效项目点数上调不超过20%，需路径与随访效果达标。
- 夜班奖励：医院一级直接分配到个人，不纳入科室二次分配；详见附件1（班次认定、金额、扣减规则）。
- 医技单项奖励（超额累进）：以2025年月均工作量为基数，分梯度奖励（0—90%→×0.1；90—120%→×0.3；120—150%→×0.5；150—180%→×0.8；>180%→×1.6）；质量阈值（报告时效、差错率、临床匹配度）不达标不享受累进。
- 科室协作绩效：MDT或上下游转接案例依据闭环确认分配奖励（示例：上游30%、下游70%），按病例清单与路径做账。
- 质量管理绩效：依据《全面质量考核标准》得分，每1分对应质量管理绩效100元；需完成年度达标与审计。

## 九、治理、审计与风控机制
- 参数管理：A%、点单价、KPI权重与映射区间统一由绩效管理委员会设定；调整需审批与公示。
- 数据来源与对账：HIS/LIS/PACS/医保结算/财务系统；月度核算与季度复核；异常结构监控（异常增长、项目拆分、路径偏离）。
- 反舞弊与纠偏：对过度检查、违规拆分、选择性接诊等行为设立扣减与惩戒；建立复议与申诉流程。
- 透明与沟通：核算报表与科室绩效说明每月公示；提供个人绩效条目查询与解释。

## 十、实施与过渡
- 试运行：2025年Q1试运行，Q2正式实施；Q1期间收集反馈并微调参数。
- 培训与宣贯：开展制度与信息系统培训，统一口径与流程。
- 过渡规则：历史绩效不用于点单价测算；按预算与有效点数重新校准。

## 十一、附件（需完善并公示）
- 附件1：夜班与节假日绩效细则（班次、金额、扣减、质控门槛）
- 附件2：KPI指标库与评分标准（各职系权重、评分表、映射区间）
- 附件3：RBRVS点数字典（项目、点数、版本、维护人）
- 附件4：DRG基础费率与权重表（版本、数据来源）
- 附件5：成本分摊字典（分摊基准、比例、数据源与审计）
- 附件6：扶持绩效政策与退出机制（适用条件、期限、退出标准）

---
说明：本文档为统一口径的制度文本，旨在消除原方案中的口径冲突与双计风险，确保绩效核算与质量、安全、成本管控相互一致。
文档信息（请勿删除）
- 文件名：HMS-Vue-Plan-Component-Governance-and-LowCode.md（本次重命名）
- 上次文件名：HMS-Vue-Plan-and-Component-Governance.md
- 更新时间：2025-09-27
- 本次增补：组件复杂性治理方案、页面路径约定、低代码/可视化拖拽前端生成平台方案
- 页面路径约定：首页 /hms；index.html 点击跳转至 /hms/index.html；其他页面位于 /hms/pages/...
-->
# HMS Vue 迁移与医疗专用组件库建设方案（草案）

本文档整理我们关于“将 hms demo 迁移到 Vue，并沉淀为医疗前端组件与数据能力库”的讨论，面向生产部署落地。

## 1. 目标与范围
- 目标：以 Vue3+TS 重构 hms，并建设可复用、可发布的医疗专用组件库，统一体验与工程能力。
- 后端栈对齐：Spring Boot + JDBC Pool -> Spark Thrift；底层 Delta Lake + Hive Metastore；FHIR 标准经 HAPI 校验与 ETL 平铺入 Delta。
- 范围：
  - 新建 Vue 应用，部署在 `/hms` 路径（不动现有 hms 目录）。
  - 建设 Monorepo 多包组件与数据能力库，应用复用库。

## 2. 总体架构与目录（Monorepo）
- 管理：pnpm workspace 或 npm workspaces + changesets（统一版本与发布日志）。
- 包建议：
  - `@hms/medical-ui`：基础 UI 与医疗业务组件（KPI、表格、表单、布局、导航、告警）。
  - `@hms/charts`：ECharts 的 Vue 封装与行业图型（趋势、工作量、分布、OR 甘特、地理飞线）。
  - `@hms/data-client`：HTTP/SSE/WebSocket 客户端、异步 Job、鉴权、重试、缓存、错误处理。
  - `@hms/fhir`：精选 FHIR 类型与 DTO 映射、Adapter（FHIR/DTO/Props）。
  - `@hms/icons`：医疗专用 SVG 图标。
  - `@hms/docs`：文档站（VitePress/Storybook），含组件 Demo 与接口契约。
  - `@hms/playground`：沙箱应用联调与演示（不发布）。
- 规范：TS 严格、ESLint+Prettier、commitlint、lint-staged+husky；构建 ESM+CJS+d.ts，声明 peerDependencies（vue/echarts/element-plus）。

## 3. 技术栈与基础设施
- 应用：Vue3 + TS + Vite + Vue Router（Hash 模式）+ Pinia。
- UI 基座：Element Plus（或替代），在 `@hms/medical-ui` 上行业抽象，支持按需加载。
- 图表：ECharts + 统一主题与色板，深浅模式无闪屏切换。
- 数据层：Axios + Vue Query（缓存、重试/退避、失效策略、并发控制）；关键数据用 zod 运行时校验。
- i18n：内置 zh-CN，预留多语言键。
- 测试：Vitest（单元/组件）+ Playwright（E2E），可选 Storybook 视觉回归。
- 可观测性：Sentry、Web Vitals、traceparent 透传（前后端日志关联）。

## 4. 路由、部署与环境
- 路由与路径：Vite `base=/hms/`；采用 Hash 路由（`/#/…`），兼容静态托管无需后端重写。
- 环境变量：`.env`/`.env.production` 定义 `VITE_API_BASE_URL`、`VITE_APP_NAME`、`VITE_BUILD_TIME` 等。
- Nginx/网关：
  - 静态：`/hms` -> 前端构建产物。
  - 反向代理：`/api` -> Spring Boot（开启 CORS、压缩、合理超时）；ETag/Cache-Control。
- 资源与缓存：分包、资源 hash、gzip/br；主静态长缓存、HTML 短缓存。

## 5. 数据访问与前后端契约
- 统一 API 前缀建议：`/api/hms/v1`。
- 鉴权：Spring Security + JWT/OIDC（Access/Refresh）；前端 Token 管理与刷新，所有请求携带 Correlation-Id。
- 通用查询参数：分页（`page`,`pageSize`）、排序（`sort=field:asc|desc`）、筛选（`filter.xxx=`）、字段投影（`fields=`）。
- 时间规范：ISO8601（含时区）或后端统一 UTC，前端本地化展示。
- 错误结构：`{ code, message, details?, traceId? }`。
- 异步作业模式（长查询）：
  - `POST /api/hms/v1/jobs` -> `{ jobId }`
  - `GET /api/hms/v1/jobs/{id}` -> `{ status, progress, startedAt, finishedAt, error? }`
  - `GET /api/hms/v1/jobs/{id}/result` -> 数据（分页/游标）
  - `DELETE /api/hms/v1/jobs/{id}` -> 取消
- SSE（实时大屏）：`GET /api/hms/v1/stream/events`（text/event-stream）；心跳与断线重连；事件去重。
- 导出与大结果：`GET /api/hms/v1/export?format=csv|parquet&…`，前端流式下载；必要时 Range 断点续传。

## 6. FHIR 与 DTO 映射策略
- 优先资源：Patient、Encounter、Observation、Procedure、Condition、Medication。
- 原则：服务端负责 FHIR 原生校验与平铺；前端组件使用稳定 DTO，不直接耦合复杂 FHIR 结构。
- DTO 示例：
  - EncounterDTO：`{ id, patientId, department, practitioner, startAt, endAt, status, diagnosis[], costSummary? }`
  - ObservationDTO：`{ id, patientId, code, display, value, unit, effectiveAt, referenceRange?, abnormalFlag? }`
- 适配：`fhirToDto(resource)` 与 `dtoToProps(dto)` 分离，组件仅面向 Props。

## 7. 医疗组件库设计（示例）
- 布局：PageLayout、SectionCard、Toolbar、FilterBar、ResponsiveGrid。
- 指标：KpiTile、KpiGroup、KpiTrend（阈值、同比环比、迷你趋势）。
- 列表/表格：SmartTable（列定义、服务端分页筛选排序、导出）。
- 流程/计划：ORScheduleGantt、WardBedOccupancy。
- 工作量/分析：DepartmentWorkloadChart、ExamVolumeChart、PathologyTATChart。
- 告警/消息：AlertTicker、EventTimeline。
- 地图/流向：GeoReferralFlow（飞线）、RegionChoropleth。
- 通用图表：TrendLine、Bar/StackBar、PieDonut、Gauge、Sankey/Chord。
- Props 示例：
  - KpiTile: `{ label, value, unit?, delta?, trend?, thresholds? }`
  - TrendLine: `{ series: { name, data:[ts,value][] }[], timeRange:[start,end], yUnit?, smooth? }`
  - GeoReferralFlow: `{ points:[{name,lng,lat}] ; links:[{from,to,weight}] ; highlightRegions? }`

## 8. 主题与设计系统
- 设计 Token（CSS 变量）：色板、字号、间距、阴影、圆角、语义/状态色。
- HmsThemeProvider + useTheme；大屏与桌面密度策略；品牌化（主色/Logo/图表色板）。

## 9. 可观测性、安全与合规
- 监控：Sentry、Web Vitals；接口错误统一上报；traceparent 透传。
- 安全：防 XSS/CSRF、CSP 白名单、最小化 CORS；前端不存敏感数据。
- 权限：路由守卫与组件级 RBAC（指令/高阶组件）。

## 10. 性能与大数据策略
- 前端：Vue Query 缓存与失效、虚拟化列表、图表抽样/分桶。
- 数仓：高频指标预聚合 Delta 表；长查询走 Job；导出走流式。
- 地图/飞线：按需加载地理资源、数据切片与简化、动画显隐控制。

## 11. 测试与质量保证
- 单元/组件测试覆盖核心组件与数据层；E2E 路由与关键流程；可选视觉回归。
- Mock：MSW 或仓库内模拟服务，确保“后端未就绪也能开发”。
- 编码规范与预提交钩子；统一 UTF-8 编码。

## 12. 构建、发布与部署
- 库构建：Vite 库模式，输出 ESM/CJS/d.ts；sideEffects 标注、tree-shaking 友好；样式独立入口。
- 版本与发布：changesets + semver；GitHub Actions/私有 npm（Verdaccio/Nexus）。
- 应用部署：CI 打包、Nginx 发布；`/api` 反代 Spring Boot；缓存策略与健康检查。

## 13. 里程碑与 DoD
- P0（1 周）：Monorepo 骨架、docs 骨架、`@hms/data-client` 初版（REST+拦截器）。
- P1（2-3 周）：`@hms/medical-ui`（KpiTile/KpiGroup、SectionCard、SmartTable），`@hms/charts`（TrendLine、Bar、PieDonut）。
- P2（1-2 周）：Job 模式、SSE 通道、下载器；长查询闭环与实时大屏示例。
- P3（持续）：首页/关键指标/经济效益/内镜迁移为库组件最佳实践页面。
- P4：i18n/A11y/主题定制、文档与运维手册，发布 v1.0。

## 14. 风险与规避
- 路由与部署路径不一致：固定 `base=/hms` 与 Hash 路由。
- 长查询阻塞：一律走 Job + 预聚合；前端交互非阻塞。
- ECharts 性能：大数据抽样与动画受控；按需渲染与销毁。
- 契约漂移：OpenAPI 契约 + zod 校验；CI 合同测试。
- 依赖升级破坏：changesets + 预发通道，Playground 先行验证。

## 15. 待确认事项（决策）
1) 包前缀：`@hms/*` 还是 `@yourorg/hms-*`？
2) UI 基座：是否采用 Element Plus？
3) 发布渠道：私有 npm（Verdaccio/Nexus）或 GitHub Packages？
4) API 基础路径：`/api/hms/v1` 是否可用？鉴权采用 JWT/OIDC 是否符合后端规划？
5) SSE 频道与心跳间隔偏好（如 metrics、alerts、system；心跳 15-30s）？
6) 首批组件优先级：KpiTile/KpiGroup、TrendLine、SmartTable、GeoReferralFlow 是否符合预期？
7) 首个应用里程碑页面：是否按“首页总览 + 关键指标 + 经济效益 + 内镜”落地？

## 16. 下一步
- 你确认上述选项后，我将提供：
  - Monorepo 顶层目录与包结构草案
  - 首批组件（6 个）的 Props 设计清单
  - `@hms/data-client` 的请求/响应与 Job/SSE 契约示例
  - CI/CD 与发布流程的 YAML 草案

## 17. 组件复杂性治理方案
为解决“各业务线图表、表格、Card 组件特别多，前端复杂度高”的问题，采用“分层组件架构 + Headless/Renderer + 配置驱动页面 + 标准化契约 + 质量门禁”的方法系统治理：

### 17.1 分层组件架构（三层清晰边界）
- 基础层（Primitives）：基于 Element Plus 的按钮、表单控件、卡片壳、布局容器、弹窗/抽屉等，统一样式与主题 Token，几乎不含业务逻辑。
- 模式层（Patterns）：图表封装（趋势/柱状/饼/仪表/桑基/地理）与表格封装（服务端分页/筛选/导出），统一 ECharts 适配与主题，如 TrendLine、BarStack、PieDonut、Gauge、Sankey、SmartTable。
- 领域层（Domain）：业务语义组件组合模式层与基础层，内置字段含义与默认展示，如 EndoscopyWorkload、EconomicOverview、PathologyTAT、DepartmentWorkload。

### 17.2 Headless + Renderer（易测试、易换皮）
- Headless（逻辑核）：数据拉取、Job 轮询、SSE 订阅、DTO/FHIR 适配、阈值计算、同比环比、异常标识等。
- Renderer（渲染器）：Element Plus + ECharts 渲染图表与界面；主题、尺寸、交互（tooltip/legend）在此层。
- 好处：领域组件无 UI 也可测（Vitest），渲染器走视觉回归（Playwright）；未来更换 UI 基座或图表库成本可控。

### 17.3 配置驱动页面（Dashboard Schema）
- 用 JSON/YAML Schema 描述页面布局、组件类型、数据绑定与交互，页面通过渲染器解析 Schema 直接出 UI。
- Schema 关键字段：layout、components（类型/Props）、dataBinding（REST/Job/SSE 绑定、缓存 TTL、参数映射）、actions（筛选/联动/跳转）、i18n。
- 效果：大部分页面通过配置拼装，无需为每个业务单独写大量模板逻辑；后端增加新指标时，仅需更新 Schema 与数据集市。

### 17.4 标准化数据契约（Props/Query/状态/事件）
- Props：统一数据、状态、样式、行为与事件 onSelect/onDrillDown/onExport/onRefresh 的约定。
- 查询协议：REST 快速接口（分页/筛选/排序/投影一致参数）、Job 模式（提交/状态/结果/取消）、SSE（统一入口与主题、心跳与去重）。
- 缓存：Vue Query 统一 TTL（如首页/关键指标 30-60s），失效策略与后台刷新；请求取消与重试/退避一致。
- 错误与可观测性：统一返回结构（code/message/details/traceId），Sentry 上报，traceparent 关联后端日志。

### 17.5 性能与大数据呈现策略
- 图表/表格：大数据抽样/分桶，依据视窗增量更新；虚拟列表与细粒度分页；懒加载非视区；按需渲染与销毁图表实例。
- 主题一致性：统一色板与样式 Token；ECharts 主题与 UI 主题同步切换，避免闪屏。
- 并发与取消：组件层面请求可取消、共享缓存避免重复拉取；指数退避重试并设上限。

### 17.6 命名、目录与版本治理
- 目录：medical-ui（基础/模式/领域三层）、charts（line/bar/pie/gauge/sankey/geo）、data-client（rest/job/sse）。
- 版本：changesets + semver；每次变更附带组件 cookbook 示例与迁移说明；预发通道验证后再发布。

### 17.7 文档与资产化
- Cookbook + Playground：每组件提供最小示例、业务场景示例、大数据示例、错误/空态示例；Playground 演示 Schema 渲染整页，便于产品/后端协同。

### 17.8 从现有项目抽取映射
- 指标与趋势：`hms/js/key-indicators.js`、`hms/js/economic-benefit.js` 抽象为 KpiTile/KpiGroup 与 TrendLine。
- 通用图表封装：`hms/js/medical-charts.js`、`hms/js/echarts.min.js` 抽象为 charts 包。
- 领域页面：`hms/js/endoscopy.js` 与 `hms/pages/endoscopy.html` 抽象为 EndoscopyWorkload 等领域组件；`hms/js/department-report.js` 抽象为科室工作量组件。
- 样式与导航：`hms/css/common.css`、`hms/css/style.css`、`hms/components/nav.html` 抽象 PageLayout 与导航组件。

### 17.9 协作与质量门禁
- 设计评审：每个新组件先出 Props 草案与示例再开发，避免契约漂移。
- 契约生成：后端 OpenAPI -> 前端 TS 类型与客户端生成；组件只面向稳定 DTO。
- 测试门禁：单元（逻辑）+ 截图（视觉）+ E2E（路由/交互）三道门；CI 必过。

### 17.10 落地路径与节奏建议
- P0：建立三层架构与核心模式组件（TrendLine/Bar/Pie/SmartTable/KpiTile/SectionCard）+ data-client。
- P1：抽取 Endoscopy/EconomicOverview 等 3-4 个领域组件为样板；跑通 Schema 渲染器页面。
- P2：将首页、关键指标、经济效益、内镜迁移为“Schema + 组件”的新实现；接通预聚合 REST 与 Job。
- P3：推广至其他业务线；完善文档站与主题/i18n/A11y。

## 18. 页面路径约定（现网约束）
- 首页入口：`/hms`。
- 实际主页：首页 `index.html` 点击后直接跳转到 `/hms/index.html`。
- 其他业务页面：均在 `/hms/pages/...` 路径下（如 `/hms/pages/endoscopy.html`）。

以上约定已在方案内路由与部署设计中考虑（Vite base=/hms/、Hash 路由与静态托管兼容）。

<!-- 文档重命名与版本注释：2025-09-27 已追加“低代码/可视化拖拽前端生成平台方案”，并计划重命名以突出 Low-code 能力与组件治理的综合方案。 -->
目标
- 用统一的 Dashboard Schema 驱动页面生成，通过运行时 Renderer 渲染与可视化 Builder 编辑，实现“低门槛、快速交付”的页面生产能力。
- 与现有 /hms 与 /hms/pages/... 结构无缝集成：Schema 存于 /hms/data/pages/<page>.json，渲染入口为 /hms/pages/<page>.html，首页点击跳转至 /hms/index.html。

总体架构
- Schema 层：页面与组件的标准化描述（布局、组件、数据绑定、动作、样式、权限、版本、元数据）。
- Renderer 层：Vue3 运行时引擎，解析 Schema 并渲染；内置数据源适配与缓存、事件总线、权限守卫、主题与暗色模式。
- Builder 层：可视化拖拽编辑器（画布、组件面板、属性面板、数据源面板、预览、撤销/重做、版本/发布）。
- 发布与版本化：草稿→发布→回滚；审计日志；Schema 校验与兼容性检查；CI 集成。

Schema v0.1（字段草案）
- layout：栅格/行列（grid/row/col）、断点与响应式、容器（card/tab/panel）。
- components：type（kpi、trend、table、card、filter-bar、tabs、grid、echarts-wrapper、download-button）、props（数据/样式/行为）、slots（标题/工具栏）。
- dataBinding：source={rest|job|sse}、path、params（时间范围、科室、分页等）、mapping（xAxis、yAxis、valueKey、columns）、cache={ttl, staleTime}。
- actions：onClick、onFilterChange、onTabChange 等事件，动作（路由跳转、更新查询参数、下载）。
- i18n/theme：文案键与主题变量（颜色、字号、图表主题）。
- meta：id、name、version、createdBy/updatedBy、permissions（roles/visibility）。

运行时 Renderer v1（能力）
- 组件注册与渲染：按 type 映射到 Renderer；统一空态、错误态、加载骨架；主题与暗色模式。
- 数据层：REST/Job/SSE 统一封装，缓存与失效策略；并发/取消；长查询异步态管理（loading→pending→ready）；SSE 增量更新与心跳。
- 联动与守卫：事件总线触发组件间联动（筛选→刷新数据）；路由守卫与权限校验。

可视化 Builder v1（能力）
- 画布：拖拽放置、栅格吸附、对齐与层级、移动端预览断点。
- 面板：组件侧栏（选择/编辑 props）、数据源侧栏（REST/Job/SSE 配置与字段映射）、属性面板（样式与行为）、预览与撤销/重做。
- 版本与发布：保存草稿、提交发布（输出 JSON 至 /hms/data/pages/<page>.json）；生成或更新 /hms/pages/<page>.html 入口与导航。

数据源管理与协议（默认建议）
- REST：分页/筛选/排序/字段选择、统一错误结构；缓存 TTL 30–300 秒可配；ETag/If-None-Match 支持。
- Job：POST /jobs 提交、GET /jobs/{id} 状态（轮询间隔 3–5 秒）、GET /jobs/{id}/result 拿结果、DELETE 取消；默认超时 120–300 秒，退避重试。
- SSE：事件类型（snapshot、delta、heartbeat），心跳 10–30 秒；断线重连指数退避；可选回放窗口。

发布与版本化
- 存储：/hms/data/pages/<page>.json（先本地静态，后续可接后端存储/审批流）。
- 入口：/hms/pages/<page>.html 渲染；首页 /hms/index.html 可挂载一个“可配置首页区块”。
- 审计：发布操作记录（用户、时间、摘要）；Schema 版本与兼容性校验；CI 中做 Schema 变更检测与回归用例。

与 /hms 集成落位约定
- 路径：遵循“首页：/hms、实际主页：/hms/index.html、其他页：/hms/pages/...”。
- 资源：复用现有 ECharts 与样式；Renderer 与组件库以 /hms 基础路径加载；兼容 Hash 路由与导航。

里程碑与 PoC
- M0（1周）：Schema v0.1 + Renderer v1 原型 + 基础组件 2 个（KpiTile、TrendLine）。
- M1（2–3周）：基础组件 10 个齐备 + Builder 简版 + REST 联通；PoC 页面“关键指标”Schema 存于 /hms/data/pages/key-indicators.json，渲染至 /hms/pages/key-indicators.html。
- M2（4–6周）：接入 Job/SSE、Builder 增强（撤销/预览/版本）、迁移 2–3 个业务页（经济效益/内镜）。
- M3（6–8周）：发布管道与审计、权限路由、性能优化与大数据导出、文档与 Cookbook。

权限与审计
- Builder 仅管理员可访问；运行时按 permissions 控制组件可见性；发布审计日志与审批（后续接入）。

## 19. 命名规范（BEM + 前缀）
为保证样式与结构“可读、可维护、可复用”，并避免与第三方样式或后续模块冲突，项目统一采用“BEM + 项目前缀（hms-）”命名规范，作为强制执行标准。

### 19.1 目标
- 全局唯一：所有类名统一使用前缀 hms-，避免命名冲突。
- 结构清晰：使用 BEM（Block、Element、Modifier）表达组件层级与变体。
- 低特异性：尽量使用类选择器，减少嵌套与层级依赖，降低维护成本。

### 19.2 命名规则（BEM + hms- 前缀）
- Block（块）：自成一体的组件/区域。
  - 规则：hms- + 名词（短横线分隔），示例：hms-card、hms-nav、hms-table、hms-filter-bar
- Element（元素）：属于 Block 的内部组成部分，用双下划线连接。
  - 规则：Block__Element，示例：hms-card__header、hms-card__title、hms-nav__item
- Modifier（修饰符）：表示 Block 或 Element 的“变体/状态”，用双中划线连接。
  - 规则：Block--modifier 或 Block__Element--modifier，示例：hms-card--compact、hms-card__header--sticky

约束：
- Element 只描述 Block 的直接子元素，避免层层嵌套命名（不要写 hms-card__header__title，应为 hms-card__title）。
- Modifier 仅表达“变体”，避免承载职责或额外语义，保持可组合。
- 禁止使用无前缀的类名；禁止使用 !important；禁止内联 style；禁止无设计 Token 的硬编码颜色/间距。

### 19.3 示例（Card 组件）
HTML：
```
<div class="hms-card hms-card--compact">
  <div class="hms-card__header">
    <h3 class="hms-card__title">标题</h3>
    <button class="hms-button hms-card__action">刷新</button>
  </div>
  <div class="hms-card__body">内容</div>
</div>
```
CSS：
```
.hms-card { /* 基础样式 */ }
.hms-card--compact { /* 修饰紧凑模式 */ }
.hms-card__header { /* 头部区域 */ }
.hms-card__title { /* 标题文本 */ }
.hms-card__action { /* 操作按钮 */ }
.hms-card__body { /* 主体内容 */ }
```

### 19.4 使用约束与建议
- 设计 Token：统一在全局 :root 声明颜色、间距、圆角、阴影、z-index、断点；页面样式优先使用 CSS 变量与工具类。
- 单位：字体/间距优先 rem/em；边框与像素对齐用 px；透明度与颜色格式统一。
- 图标：统一使用 SVG；图标类在 icons.css 管理。
- 通用样式：跨页复用的样式进入 common.css；页面私有样式进入 /hms/pages/css 下对应文件。

### 19.5 目录与文件命名约定（与路径约定一致）
- 首页入口：/hms（实际主页 index.html 点击后跳转到 /hms/index.html）。
- 业务页面：/hms/pages/...；页面的 HTML/CSS/JS 按目录归档（如 /hms/pages/endoscopy.html）。
- 文件命名：与页面路径对应，大小写与分隔符统一（短横线）。

### 19.6 与现有项目的落地位置（参考）
- 全局样式与设计 Token：/hms/css/common.css 的 :root。
- 图标样式：/hms/css/icons.css。
- 导航组件：/hms/components/nav.html（建议按 BEM+前缀重命名类）。
- 页面通用样式：/hms/css/style.css（逐步将非规范类替换为 hms- + BEM）。

### 19.7 工具与门禁（强制执行）
- Stylelint：检查禁止 !important、属性排序、颜色/长度/层级一致性、选择器复杂度、强制使用 CSS 变量与 hms- 前缀。
- ESLint + Prettier：统一 JS 代码风格；约束页面入口函数命名规则；数据调用经统一 data 层。
- Husky + lint-staged：开启 pre-commit 钩子，提交前必须通过 stylelint/eslint；可选 commitlint 统一提交信息格式。
- CI（GitHub Actions）：在 /hms/.github/workflows 中增加流水线（安装依赖 → 运行 stylelint/eslint → 构建前检查）；所有 PR 必须通过 CI。

### 19.8 开发 Checklist（新页面/组件）
- 是否使用 hms- 前缀？是否按 BEM 命名 Block/Element/Modifier？
- 是否使用设计 Token（无硬编码颜色/间距/圆角/阴影）？是否无内联样式与 !important？
- 是否将通用样式放入 common.css、页面私有样式归档到 pages/css？
- 是否减少选择器层级、避免位置依赖？
- 是否通过 stylelint/eslint 与 pre-commit 门禁？


质量与测试
- 类型与 Schema 校验（zod/JSON Schema）；组件单测与可视化快照；E2E（Playwright）；性能基准与可观测性（Sentry/Web Vitals）。

待拍板参数
- PoC 首批页面：是否选“关键指标”“经济效益”，首页是否挂载配置化区块？
- 协议默认：REST TTL、Job 超时/轮询、SSE 心跳与重连策略的具体阈值。
- Builder 权限：管理员独占或业务方可预览与草稿权限。
- Schema 存储：先本地 JSON，后续是否接入后端存储与审批流。